# StyleVault 后端架构设计方案

## 1. 技术栈选型与架构模式

### 1.1 核心技术栈
- **运行时**: Node.js 18.x (LTS)
- **框架**: Express.js 4.x + TypeScript 5.x
- **ORM**: Sequelize 6.x (PostgreSQL 优先支持)
- **认证**: JWT (jsonwebtoken) + bcrypt 密码加密
- **文件存储**: 本地存储 + CDN 加速 (预留 S3 支持)
- **缓存**: Redis 7.x (会话 + 热点数据缓存)
- **数据库**: PostgreSQL 14.x (主) / SQLite 3.x (开发)

### 1.2 开发工具链
- **构建**: ts-node (开发) / tsc (生产编译)
- **开发**: nodemon 热重载
- **测试**: Jest 29.x + Supertest
- **代码质量**: ESLint + Prettier + Husky Git Hooks
- **API 文档**: Swagger/OpenAPI 3.0

### 1.3 架构模式
**分层架构模式**
```
HTTP请求 → 路由层 → 控制器层 → 服务层 → 仓储层 → 数据层
         ↓        ↓        ↓        ↓        ↓
      参数校验 → 业务逻辑 → 数据访问 → 数据库操作
```

## 2. 模块划分与职责边界

### 2.1 项目目录结构
```
src/
├── controllers/          # 控制器层 - 处理HTTP请求
│   ├── auth.controller.ts
│   ├── user.controller.ts
│   ├── clothing.controller.ts
│   ├── outfit.controller.ts
│   └── upload.controller.ts
├── services/            # 服务层 - 核心业务逻辑
│   ├── auth.service.ts
│   ├── user.service.ts
│   ├── clothing.service.ts
│   ├── outfit.service.ts
│   └── upload.service.ts
├── repositories/        # 仓储层 - 数据访问封装
│   ├── user.repository.ts
│   ├── clothing.repository.ts
│   └── outfit.repository.ts
├── models/              # 数据模型层 - Sequelize模型
│   ├── BaseModel.ts     # 基础模型抽象
│   ├── User.ts
│   ├── ClothingItem.ts
│   ├── Outfit.ts
│   └── index.ts         # 模型导出和关联
├── middleware/          # 中间件层 - 横切关注点
│   ├── auth.middleware.ts
│   ├── validation.middleware.ts
│   ├── error.middleware.ts
│   └── upload.middleware.ts
├── routes/              # 路由定义
│   ├── auth.routes.ts
│   ├── user.routes.ts
│   ├── clothing.routes.ts
│   └── outfit.routes.ts
├── utils/               # 工具函数
│   ├── database.ts
│   ├── jwt.ts
│   ├── validators.ts
│   └── logger.ts
├── config/              # 配置管理
│   ├── database.config.ts
│   ├── redis.config.ts
│   └── app.config.ts
└── types/               # 类型定义
    ├── api.types.ts
    ├── model.types.ts
    └── sequelize.types.ts
```

### 2.2 各层职责定义

| 层级 | 职责范围 | 禁止行为 |
|------|----------|----------|
| **Controller** | 接收请求、参数校验、响应格式化 | 包含业务逻辑 |
| **Service** | 核心业务逻辑、事务管理、跨模型协调 | 直接操作数据库 |
| **Repository** | 数据库操作封装、查询优化 | 包含业务规则 |
| **Model** | 数据结构定义、关联关系、基础验证 | 包含业务逻辑 |

## 3. 数据模型设计

### 3.1 核心实体关系图
```mermaid
erDiagram
    User ||--o{ ClothingItem : owns
    User ||--o{ Outfit : creates
    User ||--o{ Upload : uploads
    User ||--o{ Analytics : generates
    
    ClothingItem ||--o{ ClothingTag : has
    ClothingItem ||--o{ OutfitItem : included_in
    
    Outfit ||--o{ OutfitItem : contains
    Outfit ||--o{ Analytics : tracks
    
    Category ||--o{ Category : parent
    Category ||--o{ ClothingItem : categorizes
    
    UserPreference ||--|| User : belongs_to
```

### 3.2 关键模型定义

#### 3.2.1 User 模型
```typescript
interface UserAttributes {
  id: string;
  email: string;
  username: string;
  passwordHash: string;
  avatar?: string;
  preferences: UserPreferences;
  createdAt: Date;
  updatedAt: Date;
  deletedAt?: Date;
}

// 关联关系
User.hasMany(ClothingItem, { foreignKey: 'userId' });
User.hasMany(Outfit, { foreignKey: 'userId' });
User.hasMany(Upload, { foreignKey: 'userId' });
```

#### 3.2.2 ClothingItem 模型
```typescript
interface ClothingItemAttributes {
  id: string;
  userId: string;
  categoryId: string;
  name: string;
  brand?: string;
  color: string[];
  size: string;
  price?: number;
  images: string[];
  tags: string[];
  season: Season[];
  createdAt: Date;
  updatedAt: Date;
}

// 关联关系
ClothingItem.belongsTo(User, { foreignKey: 'userId' });
ClothingItem.belongsTo(Category, { foreignKey: 'categoryId' });
ClothingItem.hasMany(ClothingTag, { foreignKey: 'clothingItemId' });
```

#### 3.2.3 Outfit 模型
```typescript
interface OutfitAttributes {
  id: string;
  userId: string;
  name: string;
  description?: string;
  season: Season;
  occasion: Occasion;
  items: OutfitItem[];
  images: string[];
  isPublic: boolean;
  likes: number;
  createdAt: Date;
  updatedAt: Date;
}

// 关联关系
Outfit.belongsTo(User, { foreignKey: 'userId' });
Outfit.hasMany(OutfitItem, { foreignKey: 'outfitId' });
```

### 3.3 数据库索引策略

| 表名 | 索引字段 | 索引类型 | 说明 |
|------|----------|----------|------|
| users | email | UNIQUE | 邮箱唯一性 |
| users | username | UNIQUE | 用户名唯一性 |
| clothing_items | user_id, category_id | COMPOSITE | 用户分类查询 |
| clothing_items | user_id, created_at | COMPOSITE | 用户时间排序 |
| outfits | user_id, season | COMPOSITE | 用户季节筛选 |
| outfits | is_public, likes | COMPOSITE | 公开搭配排序 |

## 4. 接口设计规范

### 4.1 RESTful API 设计原则
- **基础路径**: `/api/v1`
- **版本控制**: URL 路径版本化
- **HTTP方法**: GET(查询), POST(创建), PUT(更新), DELETE(删除)
- **状态码**: 2xx(成功), 4xx(客户端错误), 5xx(服务器错误)

### 4.2 标准响应格式
```typescript
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
    details?: any;
  };
  meta?: {
    timestamp: string;
    version: string;
    pagination?: PaginationMeta;
  };
}

interface PaginationMeta {
  page: number;
  limit: number;
  total: number;
  totalPages: number;
}
```

### 4.3 核心接口分组

#### 4.3.1 认证接口
```typescript
// 用户注册
POST /api/v1/auth/register
{
  "email": "user@example.com",
  "username": "username",
  "password": "password"
}

// 用户登录
POST /api/v1/auth/login
{
  "email": "user@example.com",
  "password": "password"
}

// Token 刷新
POST /api/v1/auth/refresh
{
  "refreshToken": "refresh_token"
}
```

#### 4.3.2 服装管理接口
```typescript
// 创建服装单品
POST /api/v1/clothing-items
{
  "name": "白色T恤",
  "categoryId": "category_uuid",
  "color": ["white"],
  "size": "L",
  "images": ["image_url"]
}

// 获取用户服装列表
GET /api/v1/clothing-items?category=top&season=spring&page=1&limit=20

// 更新服装单品
PUT /api/v1/clothing-items/:id
{
  "name": "白色T恤 (更新)",
  "color": ["white", "black"]
}

// 删除服装单品
DELETE /api/v1/clothing-items/:id
```

#### 4.3.3 搭配管理接口
```typescript
// 创建搭配
POST /api/v1/outfits
{
  "name": "春季日常搭配",
  "description": "舒适的春季日常穿搭",
  "season": "spring",
  "occasion": "casual",
  "itemIds": ["item1_uuid", "item2_uuid"]
}

// 获取用户搭配列表
GET /api/v1/outfits?season=spring&occasion=casual&page=1&limit=10

// 获取搭配详情
GET /api/v1/outfits/:id

// 更新搭配
PUT /api/v1/outfits/:id

// 删除搭配
DELETE /api/v1/outfits/:id
```

#### 4.3.4 文件上传接口
```typescript
// 图片上传
POST /api/v1/uploads/image
Content-Type: multipart/form-data
{
  "image": File,
  "type": "clothing|outfit|avatar"
}

// 获取上传历史
GET /api/v1/uploads?type=clothing&page=1&limit=20

// 删除上传文件
DELETE /api/v1/uploads/:id
```

## 5. 业务逻辑流程

### 5.1 服装创建流程
```mermaid
sequenceDiagram
    Client->>Controller: POST /clothing-items
    Controller->>Validation: 参数校验
    Validation->>Auth: 用户身份验证
    Auth->>Service: 调用创建服务
    Service->>Repository: 检查用户配额
    Repository->>Service: 返回配额信息
    Service->>Upload: 处理图片上传
    Upload->>Service: 返回图片URL
    Service->>Repository: 创建服装记录
    Repository->>Database: 执行插入
    Database-->>Repository: 返回创建结果
    Repository-->>Service: 返回服装数据
    Service-->>Controller: 格式化响应
    Controller-->>Client: 201 Created
```

### 5.2 搭配生成流程
```mermaid
sequenceDiagram
    Client->>Controller: POST /outfits
    Controller->>Validation: 参数校验
    Validation->>Auth: 用户身份验证
    Auth->>Service: 调用创建服务
    Service->>Repository: 验证服装归属
    Repository->>Service: 返回验证结果
    Service->>Service: 应用搭配规则
    Service->>Repository: 创建搭配记录
    Repository->>Database: 执行事务
    Database-->>Repository: 返回创建结果
    Repository-->>Service: 返回搭配数据
    Service-->>Controller: 格式化响应
    Controller-->>Client: 201 Created
```

### 5.3 搭配规则引擎
```typescript
interface OutfitRules {
  // 季节匹配规则
  seasonMatch(items: ClothingItem[], targetSeason: Season): boolean;
  
  // 色彩搭配规则
  colorHarmony(items: ClothingItem[]): boolean;
  
  // 风格一致性规则
  styleConsistency(items: ClothingItem[]): boolean;
  
  // 场合适配规则
  occasionSuitability(items: ClothingItem[], occasion: Occasion): boolean;
}
```

## 6. 安全策略

### 6.1 多层安全防护

| 安全层面 | 防护措施 | 技术实现 |
|----------|----------|----------|
| **认证** | JWT Token | jsonwebtoken + 刷新机制 |
| **授权** | 基于用户ID的数据隔离 | Repository层自动过滤 |
| **输入** | 参数验证 | express-validator + 自定义规则 |
| **数据** | SQL注入防护 | Sequelize参数化查询 |
| **文件** | 类型检查 | mime-types + 文件头验证 |
| **密码** | 加密存储 | bcrypt (10 rounds) |

### 6.2 敏感信息处理
```typescript
// 密码加密
const hashedPassword = await bcrypt.hash(password, 10);

// JWT Token 配置
const jwtConfig = {
  secret: process.env.JWT_SECRET,
  expiresIn: '24h',
  refreshExpiresIn: '7d'
};

// API密钥管理
const apiKeys = {
  aws: process.env.AWS_ACCESS_KEY_ID,
  cdn: process.env.CDN_SECRET_KEY,
  redis: process.env.REDIS_PASSWORD
};
```

### 6.3 访问控制策略
```typescript
// 基于角色的权限控制
enum UserRole {
  USER = 'user',
  ADMIN = 'admin',
  MODERATOR = 'moderator'
}

// 资源级权限检查
const canAccessResource = (userId: string, resourceOwnerId: string): boolean => {
  return userId === resourceOwnerId || isAdmin(userId);
};
```

## 7. 性能优化措施

### 7.1 数据库优化

#### 7.1.1 索引策略
```sql
-- 用户查询优化
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);

-- 服装查询优化
CREATE INDEX idx_clothing_user_category ON clothing_items(user_id, category_id);
CREATE INDEX idx_clothing_user_created ON clothing_items(user_id, created_at DESC);

-- 搭配查询优化
CREATE INDEX idx_outfits_user_season ON outfits(user_id, season);
CREATE INDEX idx_outfits_public_likes ON outfits(is_public, likes DESC);
```

#### 7.1.2 查询优化
```typescript
// 只选择需要的字段
const clothingItems = await ClothingItem.findAll({
  attributes: ['id', 'name', 'images', 'color'],
  where: { userId },
  limit: 20,
  offset: (page - 1) * 20
});

// 预加载关联数据
const outfits = await Outfit.findAll({
  include: [
    {
      model: ClothingItem,
      through: { attributes: [] }, // 不加载中间表字段
      attributes: ['id', 'name', 'images']
    }
  ]
});
```

### 7.2 缓存策略

#### 7.2.1 Redis 缓存层
```typescript
// 缓存配置
const cacheConfig = {
  session: {
    ttl: 24 * 60 * 60, // 24小时
    key: 'session:'
  },
  popularOutfits: {
    ttl: 5 * 60, // 5分钟
    key: 'popular:'
  },
  userStats: {
    ttl: 15 * 60, // 15分钟
    key: 'stats:user:'
  }
};

// 缓存使用示例
const getPopularOutfits = async (): Promise<Outfit[]> => {
  const cacheKey = 'popular:outfits';
  const cached = await redis.get(cacheKey);
  
  if (cached) {
    return JSON.parse(cached);
  }
  
  const outfits = await Outfit.findAll({
    where: { isPublic: true },
    order: [['likes', 'DESC']],
    limit: 20
  });
  
  await redis.setex(cacheKey, 300, JSON.stringify(outfits));
  return outfits;
};
```

### 7.3 文件存储优化

#### 7.3.1 图片处理流程
```typescript
// 图片上传优化
const processImageUpload = async (file: Express.Multer.File): Promise<string> => {
  // 1. 验证文件类型和大小
  validateImageFile(file);
  
  // 2. 生成唯一文件名
  const filename = `${uuidv4()}.${getFileExtension(file.originalname)}`;
  
  // 3. 压缩图片 (WebP格式)
  const compressedBuffer = await sharp(file.buffer)
    .resize(800, 800, { fit: 'inside', withoutEnlargement: true })
    .webp({ quality: 80 })
    .toBuffer();
  
  // 4. 上传到存储
  const url = await uploadToStorage(filename, compressedBuffer);
  
  return url;
};
```

#### 7.3.2 CDN 配置
```typescript
const cdnConfig = {
  baseUrl: process.env.CDN_BASE_URL,
  imageSizes: {
    thumbnail: { width: 150, height: 150 },
    medium: { width: 400, height: 400 },
    large: { width: 800, height: 800 }
  },
  cacheHeaders: {
    'Cache-Control': 'public, max-age=31536000', // 1年
    'ETag': true
  }
};
```

## 8. 监控与运维

### 8.1 日志记录

#### 8.1.1 结构化日志
```typescript
// Winston 日志配置
const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
    new winston.transports.File({ filename: 'logs/combined.log' }),
    new winston.transports.Console({
      format: winston.format.simple()
    })
  ]
});

// 请求日志中间件
const requestLogger = morgan(
  ':method :url :status :res[content-length] - :response-time ms',
  {
    stream: {
      write: (message: string) => logger.info(message.trim())
    }
  }
);
```

### 8.2 健康检查

#### 8.2.1 健康检查端点
```typescript
// 健康检查控制器
const healthCheck = async (req: Request, res: Response) => {
  const health = {
    status: 'healthy',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    services: {
      database: await checkDatabaseConnection(),
      redis: await checkRedisConnection(),
      storage: await checkStorageConnection()
    },
    version: process.env.npm_package_version || '1.0.0'
  };
  
  res.status(200).json(health);
};
```

#### 8.2.2 监控指标
```typescript
// 性能监控中间件
const performanceMonitor = (req: Request, res: Response, next: NextFunction) => {
  const start = Date.now();
  
  res.on('finish', () => {
    const duration = Date.now() - start;
    
    // 记录性能指标
    logger.info('Request completed', {
      method: req.method,
      url: req.url,
      status: res.statusCode,
      duration,
      userAgent: req.get('User-Agent'),
      ip: req.ip
    });
    
    // 发送到监控系统
    metrics.recordHttpRequest(req.method, req.url, res.statusCode, duration);
  });
  
  next();
};
```

## 9. 部署架构

### 9.1 环境分离

#### 9.1.1 环境配置
```typescript
// 环境配置映射
const environments = {
  development: {
    database: {
      dialect: 'sqlite',
      storage: './database.sqlite'
    },
    storage: {
      type: 'local',
      path: './uploads'
    },
    redis: {
      host: 'localhost',
      port: 6379
    }
  },
  
  testing: {
    database: {
      dialect: 'postgres',
      host: 'localhost',
      database: 'stylevault_test'
    },
    storage: {
      type: 'local',
      path: './test-uploads'
    }
  },
  
  production: {
    database: {
      dialect: 'postgres',
      host: process.env.DB_HOST,
      database: process.env.DB_NAME,
      username: process.env.DB_USER,
      password: process.env.DB_PASSWORD,
      ssl: true,
      pool: {
        max: 20,
        min: 5,
        acquire: 30000,
        idle: 10000
      }
    },
    storage: {
      type: 's3',
      bucket: process.env.S3_BUCKET,
      region: process.env.S3_REGION
    },
    redis: {
      host: process.env.REDIS_HOST,
      port: process.env.REDIS_PORT,
      password: process.env.REDIS_PASSWORD
    }
  }
};
```

### 9.2 容器化部署

#### 9.2.1 Dockerfile
```dockerfile
# 多阶段构建
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production && npm cache clean --force
COPY . .
RUN npm run build

FROM node:18-alpine AS runtime
WORKDIR /app
RUN apk add --no-cache dumb-init
ENV NODE_ENV=production
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package*.json ./
EXPOSE 3000
USER node
ENTRYPOINT ["dumb-init", "--"]
CMD ["node", "dist/app.js"]
```

#### 9.2.2 Docker Compose 配置
```yaml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://user:pass@postgres:5432/stylevault
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis
  
  postgres:
    image: postgres:14-alpine
    environment:
      POSTGRES_DB: stylevault
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
  
  redis:
    image: redis:7-alpine
    command: redis-server --requirepass password
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

## 10. 扩展性设计

### 10.1 水平扩展

#### 10.1.1 无状态服务设计
- **会话存储**: Redis 集群
- **文件存储**: 分布式对象存储 (S3)
- **数据库**: 读写分离 + 连接池

#### 10.1.2 负载均衡配置
```nginx
upstream backend {
  least_conn;
  server app1:3000 weight=3;
  server app2:3000 weight=2;
  server app3:3000 weight=1;
}

server {
  listen 80;
  location / {
    proxy_pass http://backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}
```

### 10.2 功能扩展

#### 10.2.1 插件系统架构
```typescript
interface Plugin {
  name: string;
  version: string;
  initialize: (app: Express) => void;
  routes?: Router[];
  middleware?: RequestHandler[];
}

// 插件注册机制
class PluginManager {
  private plugins: Map<string, Plugin> = new Map();
  
  register(plugin: Plugin): void {
    this.plugins.set(plugin.name, plugin);
    plugin.initialize(this.app);
  }
  
  getRoutes(): Router[] {
    return Array.from(this.plugins.values())
      .flatMap(plugin => plugin.routes || []);
  }
}
```

#### 10.2.2 功能开关配置
```typescript
// 功能开关管理
interface FeatureFlags {
  enableRecommendations: boolean;
  enableSocialFeatures: boolean;
  enableAIAnalysis: boolean;
  enablePremiumFeatures: boolean;
}

const featureFlags: FeatureFlags = {
  enableRecommendations: process.env.FF_RECOMMENDATIONS === 'true',
  enableSocialFeatures: process.env.FF_SOCIAL === 'true',
  enableAIAnalysis: process.env.FF_AI === 'true',
  enablePremiumFeatures: process.env.FF_PREMIUM === 'true'
};
```

### 10.3 API 版本演进

#### 10.3.1 向后兼容策略
```typescript
// 版本路由
const v1Router = express.Router();
const v2Router = express.Router();

// 版本1路由
v1Router.use('/users', userRoutesV1);
v1Router.use('/clothing', clothingRoutesV1);

// 版本2路由 (向后兼容)
v2Router.use('/users', userRoutesV2);
v2Router.use('/clothing', clothingRoutesV2);

// 应用版本路由
app.use('/api/v1', v1Router);
app.use('/api/v2', v2Router);
```

## 11. 开发规范

### 11.1 代码规范
- **命名规范**: 使用驼峰命名法
- **类型安全**: 强制 TypeScript 严格模式
- **错误处理**: 统一错误处理中间件
- **日志记录**: 结构化日志格式

### 11.2 测试规范
- **测试覆盖率**: 最低 80%
- **测试类型**: 单元测试 + 集成测试 + E2E测试
- **测试数据**: 使用工厂模式生成测试数据

### 11.3 部署规范
- **环境变量**: 所有配置通过环境变量管理
- **健康检查**: 强制健康检查端点
- **优雅关闭**: 支持优雅关闭和重启

---

**文档版本**: 1.0.0  
**最后更新**: 2024年1月  
**维护者**: StyleVault 开发团队