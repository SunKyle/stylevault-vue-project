# StyleVault Êï∞ÊçÆËøÅÁßªÂÆûÊñΩÊåáÂçó

## üéØ ËøÅÁßªÁõÆÊ†á

Â∞ÜÁé∞ÊúâÊï∞ÊçÆÁªìÊûÑÂπ≥ÊªëËøÅÁßªÂà∞‰ºòÂåñÂêéÁöÑÊû∂ÊûÑÔºåÁ°Æ‰øùÊï∞ÊçÆÂÆåÊï¥ÊÄß„ÄÅ‰∏öÂä°ËøûÁª≠ÊÄßÔºåÂπ∂ÊúÄÂ∞èÂåñÂÅúÊú∫Êó∂Èó¥„ÄÇ

## üìä ÂΩìÂâçÊï∞ÊçÆÁªìÊûÑÊò†Â∞Ñ

### Áé∞ÊúâË°®ÁªìÊûÑÂàÜÊûê
```sql
-- Áé∞ÊúâË°®Ê∏ÖÂçï
SHOW TABLES;

-- Êï∞ÊçÆÈáèÁªüËÆ°
SELECT 
    table_name,
    table_rows,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size (MB)'
FROM information_schema.tables 
WHERE table_schema = 'stylevault';
```

### Êï∞ÊçÆÊò†Â∞ÑÂÖ≥Á≥ª

| Áé∞ÊúâË°® | Êñ∞ÁªìÊûÑ | Êò†Â∞ÑËØ¥Êòé | Â§ÑÁêÜÁ≠ñÁï• |
|--------|--------|----------|----------|
| users | User | Â≠óÊÆµÂü∫Êú¨‰∏ÄËá¥ | Áõ¥Êé•ËøÅÁßª |
| clothing_items | ClothingItem | ÁªìÊûÑ‰ºòÂåñ | ÂàÜÊâπËøÅÁßª |
| outfits | Outfit | ÂÖ≥Á≥ªÈáçÊûÑ | Â¢ûÈáèËøÅÁßª |
| categories | ClothingCategory | Êûö‰∏æÊ†áÂáÜÂåñ | Êï∞ÊçÆËΩ¨Êç¢ |
| tags | Tag + EntityTag | Â§öÂØπÂ§öÂÖ≥Á≥ª | ÂÖ≥ËÅîË°®ËøÅÁßª |

## üöÄ ÂàÜÈò∂ÊÆµËøÅÁßªËÆ°Âàí

### Phase 1: ÂáÜÂ§áÂ∑•‰Ωú (Day 1-2)

#### 1.1 ÁéØÂ¢ÉÂáÜÂ§á
```bash
# ÂàõÂª∫ËøÅÁßªÁéØÂ¢É
mkdir -p migration/{backup,scripts,logs,validation}

# ÂÆâË£Ö‰æùËµñ
npm install --save-dev typeorm sequelize-cli mysql2

# Êï∞ÊçÆÂ∫ìÂ§á‰ªΩ
mysqldump -u root -p stylevault > migration/backup/stylevault_$(date +%Y%m%d_%H%M%S).sql
```

#### 1.2 ÂàõÂª∫Êñ∞Ë°®ÁªìÊûÑ
```sql
-- ÂàõÂª∫Êñ∞Ë°®Ôºà‰∏éÁé∞ÊúâË°®Âπ∂Â≠òÔºâ
CREATE TABLE IF NOT EXISTS users_v2 (
    id VARCHAR(36) PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    profile JSON,
    preferences JSON,
    settings JSON,
    stats JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    INDEX idx_username (username),
    INDEX idx_email (email)
);

CREATE TABLE IF NOT EXISTS clothing_items_v2 (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    basic_info JSON,
    specifications JSON,
    media JSON,
    tags JSON,
    metadata JSON,
    compatibility JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_category ((specifications->>'$.category')),
    INDEX idx_created_at (created_at)
);
```

### Phase 2: Êï∞ÊçÆÈ™åËØÅ (Day 3)

#### 2.1 Êï∞ÊçÆ‰∏ÄËá¥ÊÄßÊ£ÄÊü•
```javascript
// Êï∞ÊçÆÈ™åËØÅËÑöÊú¨ migration/validate-data.js
const { validate } = require('./validators');

async function validateData() {
    const checks = [
        {
            name: 'Áî®Êà∑Êï∞ÊçÆÂÆåÊï¥ÊÄß',
            query: 'SELECT COUNT(*) as count FROM users WHERE email IS NULL OR username IS NULL',
            expected: 0
        },
        {
            name: 'Ë°£Áâ©Êï∞ÊçÆÂÖ≥ËÅîÊÄß',
            query: 'SELECT COUNT(*) as count FROM clothing_items WHERE user_id NOT IN (SELECT id FROM users)',
            expected: 0
        },
        {
            name: 'ÈáçÂ§çÊ†áÁ≠æÊ£ÄÊü•',
            query: 'SELECT name, COUNT(*) as count FROM tags GROUP BY name HAVING count > 1',
            expected: 0
        }
    ];
    
    for (const check of checks) {
        const result = await db.query(check.query);
        if (result[0].count !== check.expected) {
            throw new Error(`${check.name}: ÂèëÁé∞ ${result[0].count} Êù°ÂºÇÂ∏∏Êï∞ÊçÆ`);
        }
    }
}
```

#### 2.2 Êï∞ÊçÆÊ∏ÖÊ¥ó
```sql
-- Ê∏ÖÁêÜÊó†ÊïàÊï∞ÊçÆ
DELETE FROM clothing_items WHERE user_id IS NULL;
DELETE FROM outfits WHERE user_id IS NULL;

-- Ê†áÂáÜÂåñÊ†áÁ≠æ
UPDATE tags SET name = TRIM(LOWER(name));

-- Â§ÑÁêÜÈáçÂ§çÁî®Êà∑
DELETE u1 FROM users u1
INNER JOIN users u2 
WHERE u1.email = u2.email AND u1.id > u2.id;
```

### Phase 3: Â¢ûÈáèËøÅÁßª (Day 4-7)

#### 3.1 Áî®Êà∑Êï∞ÊçÆËøÅÁßª
```javascript
// migration/migrate-users.js
async function migrateUsers() {
    const batchSize = 1000;
    let offset = 0;
    
    while (true) {
        const users = await db.query(`
            SELECT * FROM users 
            LIMIT ${batchSize} OFFSET ${offset}
        `);
        
        if (users.length === 0) break;
        
        for (const user of users) {
            const newUser = {
                id: generateUUID(),
                username: user.username,
                email: user.email,
                profile: {
                    avatar: user.avatar_url,
                    nickname: user.username,
                    bio: null,
                    birthday: null,
                    location: null
                },
                preferences: {
                    theme: 'light',
                    language: 'zh-CN',
                    currency: 'CNY',
                    units: 'metric'
                },
                settings: {
                    privacy: {
                        profileVisibility: 'friends',
                        outfitVisibility: 'public',
                        allowComments: true,
                        allowLikes: true
                    },
                    notifications: {
                        email: true,
                        push: true,
                        like: true,
                        comment: true,
                        follow: true
                    }
                },
                stats: {
                    totalClothingItems: 0,
                    totalOutfits: 0,
                    totalLikesReceived: 0,
                    totalFollowers: 0,
                    totalFollowing: 0,
                    accountAge: 0,
                    lastActiveAt: new Date()
                },
                created_at: user.created_at,
                updated_at: user.updated_at,
                deleted_at: user.deleted_at
            };
            
            await db.query(`
                INSERT INTO users_v2 (id, username, email, profile, preferences, settings, stats, created_at, updated_at, deleted_at)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            `, [
                newUser.id, newUser.username, newUser.email,
                JSON.stringify(newUser.profile),
                JSON.stringify(newUser.preferences),
                JSON.stringify(newUser.settings),
                JSON.stringify(newUser.stats),
                newUser.created_at, newUser.updated_at, newUser.deleted_at
            ]);
        }
        
        console.log(`Migrated ${offset + users.length} users`);
        offset += batchSize;
    }
}
```

#### 3.2 Ë°£Áâ©Êï∞ÊçÆËøÅÁßª
```javascript
// migration/migrate-clothing.js
async function migrateClothingItems() {
    const categories = await db.query('SELECT * FROM categories');
    const categoryMap = new Map(categories.map(c => [c.id, c.name]));
    
    const batchSize = 500;
    let offset = 0;
    
    while (true) {
        const items = await db.query(`
            SELECT ci.*, GROUP_CONCAT(t.name) as tags
            FROM clothing_items ci
            LEFT JOIN clothing_item_tags cit ON ci.id = cit.clothing_item_id
            LEFT JOIN tags t ON cit.tag_id = t.id
            GROUP BY ci.id
            LIMIT ${batchSize} OFFSET ${offset}
        `);
        
        if (items.length === 0) break;
        
        for (const item of items) {
            const newItem = {
                id: generateUUID(),
                user_id: item.user_id,
                basic_info: {
                    name: item.name,
                    brand: item.brand || null,
                    model: null,
                    purchasePrice: item.price || 0,
                    purchaseDate: item.purchase_date,
                    purchaseLocation: null
                },
                specifications: {
                    category: categoryMap.get(item.category_id) || 'other',
                    subcategory: null,
                    color: item.color ? [{ name: item.color, hex: item.color }] : [],
                    size: {
                        system: 'CN',
                        size: item.size || 'M',
                        measurements: {}
                    },
                    material: item.material ? [item.material] : [],
                    season: item.season ? [item.season] : [],
                    gender: 'unisex',
                    ageGroup: 'adult'
                },
                media: {
                    images: item.image_url ? [{ url: item.image_url, isMain: true }] : [],
                    mainImage: item.image_url,
                    videoUrl: null
                },
                tags: item.tags ? item.tags.split(',').map(t => ({ name: t.trim(), category: 'user' })) : [],
                metadata: {
                    wearCount: item.wear_count || 0,
                    lastWorn: null,
                    condition: 'good',
                    isFavorite: item.favorite || false,
                    isArchived: false
                },
                compatibility: {
                    compatibleColors: [],
                    incompatibleColors: [],
                    styleTags: []
                }
            };
            
            await db.query(`
                INSERT INTO clothing_items_v2 (id, user_id, basic_info, specifications, media, tags, metadata, compatibility, created_at, updated_at)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            `, [
                newItem.id, newItem.user_id,
                JSON.stringify(newItem.basic_info),
                JSON.stringify(newItem.specifications),
                JSON.stringify(newItem.media),
                JSON.stringify(newItem.tags),
                JSON.stringify(newItem.metadata),
                JSON.stringify(newItem.compatibility),
                item.created_at, item.updated_at
            ]);
        }
        
        console.log(`Migrated ${offset + items.length} clothing items`);
        offset += batchSize;
    }
}
```

### Phase 4: ÂàáÊç¢È™åËØÅ (Day 8)

#### 4.1 Âπ∂Ë°åÈ™åËØÅ
```javascript
// migration/parallel-validation.js
async function validateMigration() {
    const validations = [
        {
            name: 'Áî®Êà∑Êï∞Èáè‰∏ÄËá¥ÊÄß',
            oldQuery: 'SELECT COUNT(*) as count FROM users',
            newQuery: 'SELECT COUNT(*) as count FROM users_v2',
            tolerance: 0
        },
        {
            name: 'Ë°£Áâ©Êï∞Èáè‰∏ÄËá¥ÊÄß',
            oldQuery: 'SELECT COUNT(*) as count FROM clothing_items',
            newQuery: 'SELECT COUNT(*) as count FROM clothing_items_v2',
            tolerance: 0
        },
        {
            name: 'Êï∞ÊçÆÂÆåÊï¥ÊÄß',
            newQuery: `
                SELECT COUNT(*) as count FROM clothing_items_v2 
                WHERE JSON_EXTRACT(basic_info, '$.name') IS NULL
            `,
            expected: 0
        }
    ];
    
    for (const validation of validations) {
        const oldResult = await db.query(validation.oldQuery);
        const newResult = await db.query(validation.newQuery);
        
        const oldCount = oldResult[0]?.count || 0;
        const newCount = newResult[0]?.count || 0;
        
        if (Math.abs(oldCount - newCount) > (validation.tolerance || 0)) {
            throw new Error(`${validation.name}: Êï∞ÊçÆ‰∏ç‰∏ÄËá¥ (${oldCount} vs ${newCount})`);
        }
    }
    
    console.log('‚úÖ ÊâÄÊúâÈ™åËØÅÈÄöËøá');
}
```

#### 4.2 Â∫îÁî®ÂàáÊç¢
```sql
-- ÂàõÂª∫ËßÜÂõæÂÆûÁé∞Êó†ÁºùÂàáÊç¢
CREATE OR REPLACE VIEW users_current AS
SELECT * FROM users_v2;

CREATE OR REPLACE VIEW clothing_items_current AS
SELECT * FROM clothing_items_v2;

-- ÈáçÂëΩÂêçË°®ÂÆûÁé∞ÊúÄÁªàÂàáÊç¢
RENAME TABLE users TO users_old, users_v2 TO users;
RENAME TABLE clothing_items TO clothing_items_old, clothing_items_v2 TO clothing_items;
```

### Phase 5: Ê∏ÖÁêÜÂõûÊªö (Day 9-10)

#### 5.1 ÂõûÊªöÊñπÊ°à
```sql
-- Âø´ÈÄüÂõûÊªöËÑöÊú¨
CREATE PROCEDURE rollback_migration()
BEGIN
    START TRANSACTION;
    
    -- ÂõûÊªöÁî®Êà∑Ë°®
    RENAME TABLE users TO users_v2, users_old TO users;
    
    -- ÂõûÊªöË°£Áâ©Ë°®
    RENAME TABLE clothing_items TO clothing_items_v2, clothing_items_old TO clothing_items;
    
    COMMIT;
END;
```

#### 5.2 Ê∏ÖÁêÜÊóßÊï∞ÊçÆ
```sql
-- Á°ÆËÆ§Êó†ËØØÂêéÊ∏ÖÁêÜÊóßË°®
DROP TABLE IF EXISTS users_old;
DROP TABLE IF EXISTS clothing_items_old;

-- Ê∏ÖÁêÜËøÅÁßªÁõ∏ÂÖ≥Ë°®
DROP TABLE IF EXISTS migration_log;
```

## üîç ÁõëÊéß‰∏éÈ™åËØÅ

### ÂÆûÊó∂ÁõëÊéßÊåáÊ†á
```javascript
// migration/monitor.js
const monitoring = {
    metrics: {
        migrationProgress: 0,
        errorCount: 0,
        processingSpeed: 0,
        estimatedCompletionTime: null
    },
    
    async updateProgress(current, total) {
        this.metrics.migrationProgress = (current / total) * 100;
        this.metrics.processingSpeed = current / (Date.now() - startTime) * 1000;
        
        console.log(`Progress: ${this.metrics.migrationProgress.toFixed(2)}%`);
        console.log(`Speed: ${this.metrics.processingSpeed.toFixed(0)} items/sec`);
    },
    
    async logError(error, context) {
        this.metrics.errorCount++;
        console.error(`Migration Error [${context}]:`, error);
        
        await db.query(`
            INSERT INTO migration_log (error_type, error_message, context, timestamp)
            VALUES (?, ?, ?, NOW())
        `, [error.name, error.message, context]);
    }
};
```

### Êï∞ÊçÆÈ™åËØÅÊä•Âëä
```bash
# ÁîüÊàêËøÅÁßªÊä•Âëä
node migration/generate-report.js

# Êä•ÂëäÂÜÖÂÆπÁ§∫‰æã
Migration Report
================
Start Time: 2024-01-15 10:00:00
End Time: 2024-01-15 10:45:32
Duration: 45 minutes 32 seconds

Data Migrated:
- Users: 1,234 (100%)
- Clothing Items: 5,678 (100%)
- Outfits: 890 (100%)
- Tags: 456 (100%)

Validation Results:
- Data Integrity: ‚úÖ PASS
- Referential Integrity: ‚úÖ PASS
- Index Performance: ‚úÖ PASS
- Application Tests: ‚úÖ PASS

Errors:
- Total Errors: 0
- Critical Errors: 0
- Warnings: 2 (Â∑≤Â§ÑÁêÜ)
```

## üö® Â∫îÊÄ•Â§ÑÁêÜ

### Â∏∏ËßÅÈîôËØØÂ§ÑÁêÜ
```javascript
// migration/error-handler.js
const errorHandler = {
    async handleDuplicateUser(error) {
        console.log('ÂèëÁé∞ÈáçÂ§çÁî®Êà∑ÔºåÊâßË°åÂêàÂπ∂Á≠ñÁï•...');
        // ÂêàÂπ∂Áî®Êà∑Êï∞ÊçÆÈÄªËæë
    },
    
    async handleMissingCategory(error) {
        console.log('ÂèëÁé∞Áº∫Â§±Á±ªÂà´ÔºåÂàõÂª∫ÈªòËÆ§Á±ªÂà´...');
        // ÂàõÂª∫ÈªòËÆ§Á±ªÂà´ÈÄªËæë
    },
    
    async handleInvalidJson(error) {
        console.log('JSONÊ†ºÂºèÈîôËØØÔºåÂ∞ùËØï‰øÆÂ§ç...');
        // JSON‰øÆÂ§çÈÄªËæë
    }
};
```

### ÊÄßËÉΩ‰ºòÂåñÂª∫ËÆÆ
```sql
-- ËøÅÁßªÊúüÈó¥‰ºòÂåñ
SET GLOBAL innodb_buffer_pool_size = 2G;
SET GLOBAL max_connections = 200;
SET GLOBAL innodb_flush_log_at_trx_commit = 2;

-- ÊâπÈáèÊèíÂÖ•‰ºòÂåñ
SET autocommit = 0;
SET unique_checks = 0;
SET foreign_key_checks = 0;
```

## üìã Ê£ÄÊü•Ê∏ÖÂçï

### ËøÅÁßªÂâçÊ£ÄÊü•
- [ ] ÂÆåÊï¥Êï∞ÊçÆÂ§á‰ªΩ
- [ ] È™åËØÅËÑöÊú¨ÈÄöËøá
- [ ] ÊµãËØïÁéØÂ¢ÉÈ™åËØÅ
- [ ] ÂõûÊªöÊñπÊ°àÂáÜÂ§á
- [ ] ÁõëÊéßÂ∑•ÂÖ∑ÈÖçÁΩÆ

### ËøÅÁßª‰∏≠Ê£ÄÊü•
- [ ] ÂÆûÊó∂ÁõëÊéßËøêË°å
- [ ] ÈîôËØØÊó•ÂøóÊ£ÄÊü•
- [ ] ÊÄßËÉΩÊåáÊ†áÁõëÊéß
- [ ] Êï∞ÊçÆ‰∏ÄËá¥ÊÄßÈ™åËØÅ

### ËøÅÁßªÂêéÊ£ÄÊü•
- [ ] Â∫îÁî®ÂäüËÉΩÊµãËØï
- [ ] ÊÄßËÉΩÂü∫ÂáÜÊµãËØï
- [ ] Êï∞ÊçÆÂÆåÊï¥ÊÄßÈ™åËØÅ
- [ ] Áî®Êà∑‰ΩìÈ™åÈ™åËØÅ

## üéØ ÊàêÂäüÊ†áÂáÜ

- ‚úÖ Èõ∂Êï∞ÊçÆ‰∏¢Â§±
- ‚úÖ Èõ∂ÂÅúÊú∫Êó∂Èó¥
- ‚úÖ ÊÄßËÉΩÊèêÂçá > 30%
- ‚úÖ Êï∞ÊçÆ‰∏ÄËá¥ÊÄß 100%
- ‚úÖ Â∫îÁî®ÊµãËØïÈÄöËøáÁéá 100%

ÈÄöËøá‰ª•‰∏äÂàÜÈò∂ÊÆµÂÆûÊñΩÔºåÂèØ‰ª•Á°Æ‰øùStyleVaultÊï∞ÊçÆÊû∂ÊûÑÁöÑÂπ≥ÊªëÂçáÁ∫ßÔºå‰∏∫Êú™Êù•ÁöÑ‰∏öÂä°Êâ©Â±ïÂ•†ÂÆöÂùöÂÆûÂü∫Á°Ä„ÄÇ