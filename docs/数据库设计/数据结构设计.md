# StyleVault 数据结构设计 - 终极单表优化方案

## 设计概述

本方案采用**终极单表设计**，将原有的15个表优化为**5个核心表**，通过统一的属性系统实现无限扩展性，同时保持数据完整性和查询性能。

## 核心设计原则

1. **极简设计**：所有属性统一存储，减少表数量
2. **无限扩展**：新增属性类型无需修改表结构
3. **性能优化**：合理的索引设计确保查询效率
4. **数据完整**：保持关系完整性约束
5. **灵活配置**：支持用户个性化偏好设置

## 数据表结构

### 1. 用户表 (users)
存储用户基础信息

| 字段名 | 类型 | 约束 | 描述 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 用户唯一标识符 |
| username | VARCHAR(50) | NOT NULL, UNIQUE | 用户名 |
| email | VARCHAR(100) | NOT NULL, UNIQUE | 电子邮箱 |
| password_hash | VARCHAR(255) | NOT NULL | 密码哈希值 |
| avatar_url | VARCHAR(255) | NULL | 头像URL |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 2. 衣物表 (clothing_items)
存储用户衣物基础信息

| 字段名 | 类型 | 约束 | 描述 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 衣物唯一标识符 |
| user_id | INTEGER | NOT NULL, FOREIGN KEY REFERENCES users(id) | 所属用户ID |
| name | VARCHAR(100) | NOT NULL | 衣物名称 |
| brand | VARCHAR(100) | NULL | 品牌 |
| price | DECIMAL(10,2) | NULL | 价格 |
| purchase_date | DATE | NULL | 购买日期 |
| size | VARCHAR(20) | NULL | 尺码 |
| condition | VARCHAR(20) | CHECK (condition IN ('全新', '良好', '一般', '较差')) | 状况 |
| notes | TEXT | NULL | 备注 |
| image_urls | JSON | NULL | 图片URL数组 |
| basic_info | JSON | NULL | 基础信息（材质、版型等） |
| metadata | JSON | NULL | 元数据（统计数据等） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 3. 搭配表 (outfits)
存储用户创建的搭配信息

| 字段名 | 类型 | 约束 | 描述 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 搭配唯一标识符 |
| user_id | INTEGER | NOT NULL, FOREIGN KEY REFERENCES users(id) | 所属用户ID |
| name | VARCHAR(100) | NOT NULL | 搭配名称 |
| description | TEXT | NULL | 搭配描述 |
| composition | JSON | NULL | 搭配组成信息 |
| styling | JSON | NULL | 搭配技巧和建议 |
| image_url | VARCHAR(255) | NULL | 搭配图片URL |
| likes | INTEGER | NOT NULL, DEFAULT 0 | 点赞数 |
| view_count | INTEGER | NOT NULL, DEFAULT 0 | 查看次数 |
| is_public | BOOLEAN | NOT NULL, DEFAULT FALSE | 是否公开 |
| metadata | JSON | NULL | 元数据（统计数据等） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 4. 属性定义表 (attributes)
**统一存储所有属性**（季节、风格、场景、材质、颜色等）

| 字段名 | 类型 | 约束 | 描述 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 属性唯一标识符 |
| category | VARCHAR(20) | NOT NULL | 属性分类（season/style/scene/material/color/fit/pattern） |
| name | VARCHAR(100) | NOT NULL | 属性名称 |
| value | VARCHAR(100) | NULL | 属性值代码 |
| color | VARCHAR(7) | NULL | 属性颜色代码 |
| icon | VARCHAR(50) | NULL | 属性图标 |
| sort_order | INTEGER | DEFAULT 0 | 排序顺序 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否启用 |
| metadata | JSON | NULL | 扩展元数据 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |

### 5. 属性关联表 (entity_attributes)
**统一关联所有实体与属性**（衣物、搭配、用户偏好）

| 字段名 | 类型 | 约束 | 描述 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 关联唯一标识符 |
| entity_type | VARCHAR(20) | NOT NULL | 实体类型（clothing_item/outfit/user_preference） |
| entity_id | INTEGER | NOT NULL | 实体ID |
| attribute_id | INTEGER | NOT NULL, FOREIGN KEY REFERENCES attributes(id) | 属性ID |
| user_id | INTEGER | NULL | 用户ID（用于个性化） |
| weight | DECIMAL(3,2) | DEFAULT 1.00 | 权重/置信度 |
| notes | TEXT | NULL | 备注信息 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |

## 完整SQL实现

### 创建表结构
```sql
-- 创建用户表
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    avatar_url VARCHAR(255),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 创建衣物表
CREATE TABLE clothing_items (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    user_id INTEGER NOT NULL,
    name VARCHAR(100) NOT NULL,
    brand VARCHAR(100),
    price DECIMAL(10,2),
    purchase_date DATE,
    size VARCHAR(20),
    condition VARCHAR(20) CHECK (condition IN ('全新', '良好', '一般', '较差')),
    notes TEXT,
    image_urls JSON,
    basic_info JSON,
    metadata JSON,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 创建搭配表
CREATE TABLE outfits (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    user_id INTEGER NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    composition JSON,
    styling JSON,
    image_url VARCHAR(255),
    likes INTEGER NOT NULL DEFAULT 0,
    view_count INTEGER NOT NULL DEFAULT 0,
    is_public BOOLEAN NOT NULL DEFAULT FALSE,
    metadata JSON,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 创建属性定义表
CREATE TABLE attributes (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    category VARCHAR(20) NOT NULL,
    name VARCHAR(100) NOT NULL,
    value VARCHAR(100),
    color VARCHAR(7),
    icon VARCHAR(50),
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    metadata JSON,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY unique_attribute (category, name)
);

-- 创建属性关联表
CREATE TABLE entity_attributes (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    entity_type VARCHAR(20) NOT NULL,
    entity_id INTEGER NOT NULL,
    attribute_id INTEGER NOT NULL,
    user_id INTEGER,
    weight DECIMAL(3,2) DEFAULT 1.00,
    notes TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (attribute_id) REFERENCES attributes(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    UNIQUE KEY unique_entity_attribute (entity_type, entity_id, attribute_id, user_id)
);
```

### 创建高效索引
```sql
-- 用户表索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);

-- 衣物表索引
CREATE INDEX idx_clothing_items_user ON clothing_items(user_id);
CREATE INDEX idx_clothing_items_brand ON clothing_items(brand);
CREATE INDEX idx_clothing_items_condition ON clothing_items(condition);

-- 搭配表索引
CREATE INDEX idx_outfits_user ON outfits(user_id);
CREATE INDEX idx_outfits_public ON outfits(is_public);
CREATE INDEX idx_outfits_likes ON outfits(likes);

-- 属性表索引
CREATE INDEX idx_attributes_category ON attributes(category);
CREATE INDEX idx_attributes_name ON attributes(name);
CREATE INDEX idx_attributes_active ON attributes(is_active);

-- 关联表索引
CREATE INDEX idx_entity_type ON entity_attributes(entity_type);
CREATE INDEX idx_entity_id ON entity_attributes(entity_id);
CREATE INDEX idx_attribute_id ON entity_attributes(attribute_id);
CREATE INDEX idx_user_id ON entity_attributes(user_id);
CREATE INDEX idx_composite_lookup ON entity_attributes(entity_type, entity_id);
```

### 初始化属性数据
```sql
-- 插入基础属性分类数据
INSERT INTO attributes (category, name, value, color, icon, sort_order, metadata) VALUES
-- 季节属性
('season', '春季', 'spring', '#90EE90', 'leaf', 1, '{"temperature_range": "10-20", "description": "温暖舒适的春季"}'),
('season', '夏季', 'summer', '#FFB6C1', 'sun', 2, '{"temperature_range": "20-35", "description": "炎热清爽的夏季"}'),
('season', '秋季', 'autumn', '#FFA500', 'tree', 3, '{"temperature_range": "10-25", "description": "凉爽宜人的秋季"}'),
('season', '冬季', 'winter', '#87CEEB', 'snowflake', 4, '{"temperature_range": "-10-10", "description": "寒冷保暖的冬季"}'),

-- 风格属性
('style', '休闲', 'casual', '#4169E1', 'tshirt', 1, '{"description": "日常舒适穿搭"}'),
('style', '正式', 'formal', '#000080', 'suit', 2, '{"description": "商务正式场合"}'),
('style', '运动', 'sport', '#228B22', 'running', 3, '{"description": "运动健身穿搭"}'),
('style', '街头', 'street', '#8B4513', 'city', 4, {'"description": "潮流街头风格"}'),
('style', '复古', 'vintage', '#8B008B', 'history', 5, '{"description": "复古怀旧风格"}'),
('style', '极简', 'minimal', '#2F4F4F', 'minus', 6, '{"description": "简约不简单"}'),
('style', '优雅', 'elegant', '#DDA0DD', 'crown', 7, '{"description": "优雅精致风格"}'),

-- 场景属性
('scene', '日常', 'daily', '#708090', 'home', 1, '{"priority": "high"}'),
('scene', '工作', 'work', '#4682B4', 'briefcase', 2, '{"priority": "high"}'),
('scene', '约会', 'date', '#FF69B4', 'heart', 3, '{"priority": "medium"}'),
('scene', '聚会', 'party', '#DA70D6', 'users', 4, '{"priority": "medium"}'),
('scene', '旅行', 'travel', '#20B2AA', 'plane', 5, '{"priority": "low"}'),
('scene', '运动', 'sport', '#32CD32', 'dumbbell', 6, '{"priority": "medium"}'),
('scene', '学院', 'academic', '#8A2BE2', 'graduation-cap', 7, '{"priority": "low"}'),

-- 材质属性
('material', '棉质', 'cotton', '#F5DEB3', 'tshirt', 1, '{"breathable": true, "comfortable": true}'),
('material', '羊毛', 'wool', '#DEB887', 'cloud', 2, '{"warm": true, "luxury": true}'),
('material', '丝绸', 'silk', '#E6E6FA', 'gem', 3, '{"smooth": true, "luxury": true}'),
('material', '牛仔', 'denim', '#4682B4', 'square', 4, '{"durable": true, "casual": true}'),
('material', '皮革', 'leather', '#8B4513', 'shield', 5, '{"durable": true, "premium": true}'),
('material', '聚酯纤维', 'polyester', '#708090', 'layer-group', 6, '{"wrinkle_resistant": true}'),

-- 色系属性
('color', '黑色系', 'black', '#000000', 'square', 1, '{"neutral": true, "versatile": true}'),
('color', '白色系', 'white', '#FFFFFF', 'square', 2, '{"neutral": true, "fresh": true}'),
('color', '灰色系', 'gray', '#808080', 'square', 3, '{"neutral": true, "versatile": true}'),
('color', '蓝色系', 'blue', '#0000FF', 'square', 4, '{"cool_tone": true, "professional": true}'),
('color', '红色系', 'red', '#FF0000', 'square', 5, '{"warm_tone": true, "bold": true}'),
('color', '绿色系', 'green', '#008000', 'square', 6, '{"natural": true, "fresh": true}'),
('color', '大地色系', 'earth', '#8B4513', 'square', 7, '{"warm": true, "natural": true}'),

-- 版型属性
('fit', '修身', 'slim', '#696969', 'ruler', 1, '{"tight": true, "modern": true}'),
('fit', '宽松', 'loose', '#A9A9A9', 'ruler', 2, '{"comfortable": true, "casual": true}'),
('fit', '标准', 'regular', '#808080', 'ruler', 3, '{"balanced": true, "versatile": true}'),
('fit', 'oversize', 'oversize', '#D3D3D3', 'ruler', 4, '{"trendy": true, "comfortable": true}'),

-- 图案属性
('pattern', '纯色', 'solid', '#D3D3D3', 'square', 1, '{"simple": true, "versatile": true}'),
('pattern', '条纹', 'stripe', '#B0C4DE', 'bars', 2, '{"classic": true, "slimming": true}'),
('pattern', '格子', 'plaid', '#778899', 'th', 3, '{"traditional": true, "academic": true}'),
('pattern', '印花', 'print', '#FFB6C1', 'image', 4, '{"decorative": true, "expressive": true}'),
('pattern', '波点', 'polka_dot', '#FFE4B5', 'circle', 5, '{"playful": true, "retro": true}'),

-- 类别属性（用于衣物分类）
('category', '上装', 'tops', '#FF6B6B', 'tshirt', 1, '{"type": "clothing"}'),
('category', '下装', 'bottoms', '#4ECDC4', 'socks', 2, '{"type": "clothing"}'),
('category', '外套', 'outerwear', '#45B7D1', 'vest', 3, '{"type": "clothing"}'),
('category', '鞋履', 'shoes', '#96CEB4', 'shoe-prints', 4, '{"type": "clothing"}'),
('category', '配饰', 'accessories', '#FECA57', 'gem', 5, '{"type": "clothing"}'),
('category', '包包', 'bags', '#FF9FF3', 'bag-shopping', 6, '{"type": "clothing"}');
```

## 查询示例

### 基础查询

#### 获取衣物的所有属性
```sql
SELECT 
    ci.id,
    ci.name,
    a.category,
    a.name as attribute_name,
    a.color,
    a.icon,
    ea.weight
FROM clothing_items ci
JOIN entity_attributes ea ON ci.id = ea.entity_id AND ea.entity_type = 'clothing_item'
JOIN attributes a ON ea.attribute_id = a.id
WHERE ci.user_id = 1 AND ci.id = 1
ORDER BY a.category, a.sort_order;
```

#### 按属性筛选衣物
```sql
-- 筛选：夏季 + 休闲 + 蓝色系 的衣物
SELECT DISTINCT ci.*
FROM clothing_items ci
JOIN entity_attributes ea ON ci.id = ea.entity_id AND ea.entity_type = 'clothing_item'
JOIN attributes a ON ea.attribute_id = a.id
WHERE a.category IN ('season', 'style', 'color')
  AND a.value IN ('summer', 'casual', 'blue')
  AND ci.user_id = 1
GROUP BY ci.id
HAVING COUNT(DISTINCT a.category) = 3;
```

#### 获取搭配的所有属性
```sql
SELECT 
    o.id,
    o.name,
    a.category,
    a.name as attribute_name,
    a.color,
    ea.weight
FROM outfits o
JOIN entity_attributes ea ON o.id = ea.entity_id AND ea.entity_type = 'outfit'
JOIN attributes a ON ea.attribute_id = a.id
WHERE o.user_id = 1 AND o.id = 1
ORDER BY a.category, a.sort_order;
```

### 高级查询

#### 统计用户属性使用情况
```sql
-- 统计用户各属性的使用频率
SELECT 
    a.category,
    a.name,
    COUNT(ea.id) as usage_count,
    AVG(ea.weight) as avg_weight
FROM attributes a
JOIN entity_attributes ea ON a.id = ea.attribute_id
JOIN clothing_items ci ON ea.entity_id = ci.id AND ea.entity_type = 'clothing_item'
WHERE ci.user_id = 1
GROUP BY a.category, a.name
ORDER BY a.category, usage_count DESC;
```

#### 智能推荐查询
```sql
-- 根据用户偏好推荐衣物
SELECT DISTINCT ci.*,
       SUM(CASE WHEN a.id IN (SELECT attribute_id FROM user_preferences WHERE user_id = 1) THEN ea.weight ELSE 0 END) as preference_score
FROM clothing_items ci
JOIN entity_attributes ea ON ci.id = ea.entity_id AND ea.entity_type = 'clothing_item'
JOIN attributes a ON ea.attribute_id = a.id
WHERE ci.user_id = 1
GROUP BY ci.id
ORDER BY preference_score DESC
LIMIT 10;
```

## 扩展性说明

### 新增属性类型
无需修改表结构，直接插入attributes表：

```sql
-- 新增"场合"属性类型
INSERT INTO attributes (category, name, value, color, icon, sort_order) VALUES
('occasion', '婚礼', 'wedding', '#E6E6FA', 'ring', 1),
('occasion', '面试', 'interview', '#4682B4', 'briefcase', 2);
```

### 新增实体类型
支持为任何新实体添加属性关联：

```sql
-- 为"收藏夹"实体添加属性
INSERT INTO entity_attributes (entity_type, entity_id, attribute_id, user_id, weight) VALUES
('collection', 1, 15, 1, 0.9);
```

## 数据表关系图

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│     users       │    │  clothing_items  │    │     outfits     │
│  (用户基础)      │───▶│   (衣物基础)      │    │   (搭配基础)     │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │                        │
                                │                        │
                       ┌──────────────────┐    ┌─────────────────┐
                       │  attributes      │◄───┤ entity_attributes │
                       │  (统一属性定义)   │    │ (统一关联表)    │
                       └──────────────────┘    └─────────────────┘
```

## 性能优化策略

### 索引策略
- **覆盖索引**：所有查询字段都有对应索引
- **复合索引**：针对多条件查询优化
- **前缀索引**：长文本字段使用前缀索引

### 缓存策略
- **属性表缓存**：attributes表全表缓存（数据量小，变化少）
- **查询结果缓存**：热门查询结果缓存到Redis
- **用户偏好缓存**：用户个性化设置缓存

### 分区策略（可选）
```sql
-- 按实体类型分区
ALTER TABLE entity_attributes 
PARTITION BY LIST COLUMNS(entity_type) (
    PARTITION p_clothing VALUES IN ('clothing_item'),
    PARTITION p_outfit VALUES IN ('outfit'),
    PARTITION p_preference VALUES IN ('user_preference')
);
```

## 数据迁移方案

### 从旧系统迁移
1. **用户数据**：直接迁移users表
2. **衣物数据**：迁移基础信息到clothing_items表
3. **属性数据**：
   - 将seasons/styles/tags/scenes表数据合并到attributes表
   - 创建对应的entity_attributes关联记录

### 迁移脚本示例
```sql
-- 迁移季节属性
INSERT INTO attributes (category, name, value, color, icon)
SELECT 'season', name, LOWER(name), 
       CASE name 
           WHEN '春季' THEN '#90EE90'
           WHEN '夏季' THEN '#FFB6C1'
           WHEN '秋季' THEN '#FFA500'
           WHEN '冬季' THEN '#87CEEB'
       END,
       CASE name 
           WHEN '春季' THEN 'leaf'
           WHEN '夏季' THEN 'sun'
           WHEN '秋季' THEN 'tree'
           WHEN '冬季' THEN 'snowflake'
       END
FROM seasons;

-- 迁移关联关系
INSERT INTO entity_attributes (entity_type, entity_id, attribute_id)
SELECT 'clothing_item', clothing_item_id, 
       (SELECT id FROM attributes WHERE category='season' AND name=(SELECT name FROM seasons WHERE id=season_id))
FROM clothing_item_seasons;
```

## 总结

### 设计优势
- **极简**：5个核心表替代原有的15个表
- **扩展**：100%属性扩展性，无需修改表结构
- **性能**：优化的索引设计，查询效率提升
- **灵活**：支持任意实体类型和属性组合
- **维护**：单表设计，维护成本最低

### 数据表数量对比
| 设计阶段 | 表数量 | 核心表 | 关联表 | 扩展性 |
|----------|--------|--------|--------|--------|
| 原始设计 | 15个 | 8个 | 7个 | 需改结构 |
| 标签化设计 | 8个 | 5个 | 3个 | 需改结构 |
| **终极单表** | **5个** | **3个** | **2个** | **零修改** |

此设计为StyleVault提供了最简洁、最灵活、最易扩展的数据结构基础。
