# StyleVault 数据结构优化 - 标签化设计方案

## 设计目标

将衣物的众多属性抽象为统一的标签系统，通过标签分类管理减少数据库表数量，提高系统灵活性和可扩展性。

## 核心优化思路

### 原有设计问题
- 15个核心表中，属性相关表占8个（seasons, styles, tags, scenes等）
- 多对多关联表过多（5个关联表）
- 新增属性类型需要新增表结构

### 标签化解决方案
- 统一标签系统：所有属性抽象为标签
- 分类管理：标签按类别分组
- 动态扩展：无需修改表结构即可新增属性类型

## 优化后的数据结构

### 1. 标签分类表 (TagCategories)

| 字段名 | 类型 | 约束 | 描述 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 分类唯一标识符 |
| name | VARCHAR(50) | NOT NULL, UNIQUE | 分类名称 |
| code | VARCHAR(20) | NOT NULL, UNIQUE | 分类代码 |
| description | TEXT | NULL | 分类描述 |
| icon | VARCHAR(50) | NULL | 分类图标 |
| sort_order | INTEGER | DEFAULT 0 | 排序顺序 |
| is_system | BOOLEAN | DEFAULT FALSE | 是否为系统内置 |

**分类示例：**
- season（季节）
- style（风格）
- scene（场景）
- material（材质）
- color_group（色系）
- pattern（图案）
- fit（版型）
- brand_group（品牌类别）

### 2. 标签表 (Tags)

| 字段名 | 类型 | 约束 | 描述 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 标签唯一标识符 |
| category_id | INTEGER | NOT NULL, FOREIGN KEY | 所属分类ID |
| name | VARCHAR(100) | NOT NULL | 标签名称 |
| value | VARCHAR(100) | NULL | 标签值（用于存储代码值） |
| color | VARCHAR(7) | NULL | 标签颜色 |
| icon | VARCHAR(50) | NULL | 标签图标 |
| description | TEXT | NULL | 标签描述 |
| sort_order | INTEGER | DEFAULT 0 | 排序顺序 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否启用 |

**标签示例：**
- 分类：season，标签：春季、夏季、秋季、冬季
- 分类：style，标签：休闲、正式、运动、街头、复古
- 分类：scene，标签：日常、工作、约会、聚会、旅行

### 3. 衣物标签关联表 (ItemTags)

| 字段名 | 类型 | 约束 | 描述 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 关联唯一标识符 |
| clothing_item_id | INTEGER | NOT NULL, FOREIGN KEY | 衣物ID |
| tag_id | INTEGER | NOT NULL, FOREIGN KEY | 标签ID |
| user_id | INTEGER | NOT NULL, FOREIGN KEY | 用户ID（用于个性化标签） |
| confidence | DECIMAL(3,2) | DEFAULT 1.00 | 标签置信度（0-1） |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

### 4. 优化后的衣物表 (ClothingItems)

| 字段名 | 类型 | 约束 | 描述 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 衣物唯一标识符 |
| user_id | INTEGER | NOT NULL, FOREIGN KEY | 所属用户ID |
| name | VARCHAR(100) | NOT NULL | 衣物名称 |
| brand | VARCHAR(100) | NULL | 品牌 |
| price | DECIMAL(10,2) | NULL | 价格 |
| purchase_date | DATE | NULL | 购买日期 |
| size | VARCHAR(20) | NULL | 尺码 |
| condition | VARCHAR(20) | CHECK (condition IN ('全新', '良好', '一般', '较差')) | 状况 |
| notes | TEXT | NULL | 备注 |
| image_urls | JSON | NULL | 图片URL数组 |
| basic_info | JSON | NULL | 基础信息（材质、版型等） |
| metadata | JSON | NULL | 元数据（统计数据等） |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 5. 搭配标签关联表 (OutfitTags)

| 字段名 | 类型 | 约束 | 描述 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 关联唯一标识符 |
| outfit_id | INTEGER | NOT NULL, FOREIGN KEY | 搭配ID |
| tag_id | INTEGER | NOT NULL, FOREIGN KEY | 标签ID |
| relevance | DECIMAL(3,2) | DEFAULT 1.00 | 关联相关性（0-1） |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

## SQL实现

### 创建标签分类表
```sql
CREATE TABLE tag_categories (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL UNIQUE,
    code VARCHAR(20) NOT NULL UNIQUE,
    description TEXT,
    icon VARCHAR(50),
    sort_order INTEGER DEFAULT 0,
    is_system BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_tag_categories_code ON tag_categories(code);
CREATE INDEX idx_tag_categories_sort ON tag_categories(sort_order);
```

### 创建标签表
```sql
CREATE TABLE tags (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    category_id INTEGER NOT NULL,
    name VARCHAR(100) NOT NULL,
    value VARCHAR(100),
    color VARCHAR(7),
    icon VARCHAR(50),
    description TEXT,
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (category_id) REFERENCES tag_categories(id),
    UNIQUE KEY unique_tag_per_category (category_id, name)
);

-- 创建索引
CREATE INDEX idx_tags_category ON tags(category_id);
CREATE INDEX idx_tags_name ON tags(name);
CREATE INDEX idx_tags_active ON tags(is_active);
```

### 创建衣物标签关联表
```sql
CREATE TABLE item_tags (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    clothing_item_id INTEGER NOT NULL,
    tag_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    confidence DECIMAL(3,2) DEFAULT 1.00,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (clothing_item_id) REFERENCES clothing_items(id),
    FOREIGN KEY (tag_id) REFERENCES tags(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    UNIQUE KEY unique_item_tag_user (clothing_item_id, tag_id, user_id)
);

-- 创建索引
CREATE INDEX idx_item_tags_item ON item_tags(clothing_item_id);
CREATE INDEX idx_item_tags_tag ON item_tags(tag_id);
CREATE INDEX idx_item_tags_user ON item_tags(user_id);
```

### 创建优化后的衣物表
```sql
CREATE TABLE clothing_items (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    user_id INTEGER NOT NULL,
    name VARCHAR(100) NOT NULL,
    brand VARCHAR(100),
    price DECIMAL(10,2),
    purchase_date DATE,
    size VARCHAR(20),
    condition VARCHAR(20) CHECK (condition IN ('全新', '良好', '一般', '较差')),
    notes TEXT,
    image_urls JSON,
    basic_info JSON,
    metadata JSON,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 创建索引
CREATE INDEX idx_clothing_items_user ON clothing_items(user_id);
CREATE INDEX idx_clothing_items_brand ON clothing_items(brand);
CREATE INDEX idx_clothing_items_condition ON clothing_items(condition);
```

## 初始化数据

### 插入标签分类
```sql
INSERT INTO tag_categories (name, code, description, icon, sort_order, is_system) VALUES
('季节', 'season', '衣物适合穿着的季节', 'calendar', 1, TRUE),
('风格', 'style', '衣物的风格类型', 'palette', 2, TRUE),
('场景', 'scene', '适合的穿着场合', 'map-marker-alt', 3, TRUE),
('材质', 'material', '衣物的主要材质', 'thread', 4, TRUE),
('色系', 'color_group', '颜色分组', 'palette', 5, TRUE),
('版型', 'fit', '衣物的版型剪裁', 'ruler', 6, TRUE),
('图案', 'pattern', '衣物图案类型', 'image', 7, TRUE),
('品牌类型', 'brand_group', '品牌分类', 'tag', 8, TRUE);
```

### 插入标签数据
```sql
-- 季节标签
INSERT INTO tags (category_id, name, value, color, icon) VALUES
(1, '春季', 'spring', '#90EE90', 'leaf'),
(1, '夏季', 'summer', '#FFB6C1', 'sun'),
(1, '秋季', 'autumn', '#FFA500', 'tree'),
(1, '冬季', 'winter', '#87CEEB', 'snowflake');

-- 风格标签
INSERT INTO tags (category_id, name, value, color, icon) VALUES
(2, '休闲', 'casual', '#4169E1', 'tshirt'),
(2, '正式', 'formal', '#000080', 'suit'),
(2, '运动', 'sport', '#228B22', 'running'),
(2, '街头', 'street', '#8B4513', 'city'),
(2, '复古', 'vintage', '#8B008B', 'history'),
(2, '极简', 'minimal', '#2F4F4F', 'minus');

-- 场景标签
INSERT INTO tags (category_id, name, value, color, icon) VALUES
(3, '日常', 'daily', '#708090', 'home'),
(3, '工作', 'work', '#4682B4', 'briefcase'),
(3, '约会', 'date', '#FF69B4', 'heart'),
(3, '聚会', 'party', '#DA70D6', 'users'),
(3, '旅行', 'travel', '#20B2AA', 'plane'),
(3, '运动', 'sport', '#32CD32', 'dumbbell');
```

## 查询示例

### 获取衣物的所有标签
```sql
SELECT 
    ci.id,
    ci.name,
    tc.name as category,
    t.name as tag_name,
    t.color as tag_color
FROM clothing_items ci
JOIN item_tags it ON ci.id = it.clothing_item_id
JOIN tags t ON it.tag_id = t.id
JOIN tag_categories tc ON t.category_id = tc.id
WHERE ci.id = 1
ORDER BY tc.sort_order, t.sort_order;
```

### 按标签筛选衣物
```sql
SELECT DISTINCT ci.*
FROM clothing_items ci
JOIN item_tags it ON ci.id = it.clothing_item_id
JOIN tags t ON it.tag_id = t.id
JOIN tag_categories tc ON t.category_id = tc.id
WHERE tc.code = 'season' 
  AND t.value = 'spring'
  AND ci.user_id = 1;
```

### 统计用户标签使用情况
```sql
SELECT 
    tc.name as category,
    t.name as tag,
    COUNT(it.id) as usage_count
FROM tag_categories tc
JOIN tags t ON tc.id = t.category_id
JOIN item_tags it ON t.id = it.tag_id
JOIN clothing_items ci ON it.clothing_item_id = ci.id
WHERE ci.user_id = 1
GROUP BY tc.name, t.name
ORDER BY tc.sort_order, usage_count DESC;
```

## 优势分析

### 减少表数量
- 原有：15个核心表
- 优化后：8个核心表（减少47%）

### 提高扩展性
- 新增属性类型只需添加标签，无需修改表结构
- 支持用户自定义标签分类
- 标签可以动态启用/禁用

### 简化查询
- 统一标签查询接口
- 支持复杂的多标签组合筛选
- 便于统计和分析用户偏好

### 性能优化
- 减少JOIN操作复杂度
- 标签表可缓存到Redis
- 支持标签索引优化

## 迁移建议

1. **数据迁移脚本**：创建标签映射关系
2. **渐进式迁移**：新旧系统并行运行
3. **数据验证**：确保标签化后的数据完整性
4. **用户培训**：更新用户界面以适应新标签系统