# StyleVault 接口开发实施指南

## 🎯 快速开始

本指南将带你完成一个完整接口的开发流程，以"用户衣物统计接口"为例。

---

## 第1步：需求分析与设计

### 需求描述
创建一个接口，统计用户的衣物总数、按分类统计、按季节统计等数据。

### API设计
```
GET /api/v1/clothing/statistics
```

### 响应格式
```json
{
  "success": true,
  "data": {
    "totalItems": 45,
    "byCategory": [
      {"category": "上衣", "count": 15, "percentage": 33.3},
      {"category": "裤子", "count": 10, "percentage": 22.2}
    ],
    "bySeason": [
      {"season": "春季", "count": 20},
      {"season": "夏季", "count": 25}
    ],
    "byColor": [
      {"color": "黑色", "count": 12},
      {"color": "白色", "count": 8}
    ]
  }
}
```

---

## 第2步：创建分支

```bash
# 从main分支创建功能分支
git checkout main
git pull origin main
git checkout -b feat/clothing-statistics

# 推送分支到远程
git push origin feat/clothing-statistics
```

---

## 第3步：数据库查询设计

### 创建统计查询方法
```typescript
// src/services/ClothingService.ts
export class ClothingService {
  /**
   * 获取用户衣物统计数据
   */
  async getClothingStatistics(userId: number): Promise<ClothingStatistics> {
    const [totalItems, byCategory, bySeason, byColor] = await Promise.all([
      // 总数量
      ClothingItem.count({ where: { userId } }),
      
      // 按分类统计
      this.getStatisticsByCategory(userId),
      
      // 按季节统计
      this.getStatisticsBySeason(userId),
      
      // 按颜色统计
      this.getStatisticsByColor(userId)
    ]);

    return {
      totalItems,
      byCategory,
      bySeason,
      byColor
    };
  }

  private async getStatisticsByCategory(userId: number) {
    const results = await ClothingItem.findAll({
      where: { userId },
      attributes: [
        [Sequelize.col('category.name'), 'category'],
        [Sequelize.fn('COUNT', Sequelize.col('clothing_items.id')), 'count']
      ],
      include: [{
        model: Category,
        attributes: []
      }],
      group: ['category.id', 'category.name'],
      raw: true
    });

    const total = results.reduce((sum, item) => sum + parseInt(item.count as string), 0);
    
    return results.map(item => ({
      category: item.category as string,
      count: parseInt(item.count as string),
      percentage: total > 0 ? Math.round((parseInt(item.count as string) / total) * 1000) / 10 : 0
    }));
  }

  private async getStatisticsBySeason(userId: number) {
    const results = await ClothingItem.findAll({
      where: { userId },
      attributes: [
        [Sequelize.col('season_attr.value'), 'season'],
        [Sequelize.fn('COUNT', Sequelize.col('clothing_items.id')), 'count']
      ],
      include: [{
        model: Attribute,
        as: 'seasonAttr',
        attributes: []
      }],
      group: ['season_attr.id', 'season_attr.value'],
      raw: true
    });

    return results.map(item => ({
      season: item.season as string,
      count: parseInt(item.count as string)
    }));
  }

  private async getStatisticsByColor(userId: number) {
    const results = await ClothingItem.findAll({
      where: { userId },
      attributes: [
        'color',
        [Sequelize.fn('COUNT', Sequelize.col('clothing_items.id')), 'count']
      ],
      where: {
        userId,
        color: { [Op.ne]: null }
      },
      group: ['color'],
      raw: true
    });

    return results.map(item => ({
      color: item.color as string,
      count: parseInt(item.count as string)
    }));
  }
}
```

---

## 第4步：创建类型定义

```typescript
// src/types/clothing.ts
export interface ClothingStatistics {
  totalItems: number;
  byCategory: CategoryStatistics[];
  bySeason: SeasonStatistics[];
  byColor: ColorStatistics[];
}

export interface CategoryStatistics {
  category: string;
  count: number;
  percentage: number;
}

export interface SeasonStatistics {
  season: string;
  count: number;
}

export interface ColorStatistics {
  color: string;
  count: number;
}
```

---

## 第5步：控制器实现

```typescript
// src/controllers/clothingController.ts
/**
 * 获取用户衣物统计数据
 * @route GET /api/v1/clothing/statistics
 */
async getStatistics(req: Request, res: Response) {
  try {
    const userId = (req as any).user.userId;

    const statistics = await clothingService.getClothingStatistics(userId);

    res.json({
      success: true,
      data: statistics,
      message: '获取统计数据成功'
    });
  } catch (error) {
    console.error('获取衣物统计数据失败:', error);
    res.status(500).json({
      success: false,
      message: '获取统计数据失败',
      error: {
        code: 'FETCH_STATISTICS_ERROR',
        details: error instanceof Error ? error.message : String(error)
      }
    });
  }
}
```

---

## 第6步：路由配置

```typescript
// src/routes/clothing.ts
// 添加统计路由
router.get('/clothing/statistics', authMiddleware, clothingController.getStatistics);
```

---

## 第7步：编写测试

### 单元测试
```typescript
// tests/services/clothingService.test.ts
describe('getClothingStatistics', () => {
  it('应该返回正确的统计数据', async () => {
    // 创建测试数据
    const user = await createTestUser();
    await createTestClothingItems(user.id, [
      { categoryId: 1, season: '春季', color: '黑色' },
      { categoryId: 1, season: '春季', color: '白色' },
      { categoryId: 2, season: '夏季', color: '黑色' }
    ]);

    const statistics = await clothingService.getClothingStatistics(user.id);

    expect(statistics.totalItems).toBe(3);
    expect(statistics.byCategory).toHaveLength(2);
    expect(statistics.bySeason).toHaveLength(2);
    expect(statistics.byColor).toHaveLength(2);
  });

  it('当没有衣物时应该返回空统计', async () => {
    const user = await createTestUser();
    
    const statistics = await clothingService.getClothingStatistics(user.id);

    expect(statistics.totalItems).toBe(0);
    expect(statistics.byCategory).toEqual([]);
    expect(statistics.bySeason).toEqual([]);
    expect(statistics.byColor).toEqual([]);
  });
});
```

### 集成测试
```typescript
// tests/integration/clothing.statistics.test.ts
describe('GET /api/v1/clothing/statistics', () => {
  let authToken: string;
  let userId: number;

  beforeEach(async () => {
    const user = await createTestUser();
    userId = user.id;
    authToken = await generateAuthToken(user);
  });

  it('应该返回用户的衣物统计数据', async () => {
    await createTestClothingItems(userId, [
      { name: 'T恤1', categoryId: 1, season: '春季' },
      { name: 'T恤2', categoryId: 1, season: '夏季' },
      { name: '牛仔裤', categoryId: 2, season: '秋季' }
    ]);

    const response = await request(app)
      .get('/api/v1/clothing/statistics')
      .set('Authorization', `Bearer ${authToken}`)
      .expect(200);

    expect(response.body.success).toBe(true);
    expect(response.body.data.totalItems).toBe(3);
    expect(response.body.data.byCategory).toBeDefined();
    expect(response.body.data.bySeason).toBeDefined();
  });

  it('当未认证时应该返回401', async () => {
    const response = await request(app)
      .get('/api/v1/clothing/statistics')
      .expect(401);

    expect(response.body.success).toBe(false);
  });
});
```

---

## 第8步：API文档

```yaml
# docs/swagger/paths/clothing.yaml
/clothing/statistics:
  get:
    summary: 获取用户衣物统计数据
    description: 获取当前用户的衣物总数、按分类、季节、颜色的统计信息
    tags: [Clothing]
    security:
      - bearerAuth: []
    responses:
      200:
        description: 统计数据获取成功
        content:
          application/json:
            schema:
              type: object
              properties:
                success:
                  type: boolean
                  example: true
                data:
                  type: object
                  properties:
                    totalItems:
                      type: integer
                      example: 45
                    byCategory:
                      type: array
                      items:
                        type: object
                        properties:
                          category:
                            type: string
                          count:
                            type: integer
                          percentage:
                            type: number
                    bySeason:
                      type: array
                      items:
                        type: object
                        properties:
                          season:
                            type: string
                          count:
                            type: integer
                    byColor:
                      type: array
                      items:
                        type: object
                        properties:
                          color:
                            type: string
                          count:
                            type: integer
                message:
                  type: string
                  example: "获取统计数据成功"
      401:
        description: 未认证
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      500:
        description: 服务器错误
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
```

---

## 第9步：运行测试

```bash
# 运行单元测试
npm run test:unit

# 运行集成测试
npm run test:integration

# 运行所有测试
npm test

# 检查测试覆盖率
npm run test:coverage
```

---

## 第10步：代码审查

### 自我检查清单
- [ ] 代码符合编码规范
- [ ] 所有测试通过
- [ ] 测试覆盖率≥80%
- [ ] API文档已更新
- [ ] 错误处理完善
- [ ] 日志记录适当

### 提交代码
```bash
# 添加文件
git add .

# 提交代码
git commit -m "feat(clothing): 添加衣物统计接口

- 实现按分类、季节、颜色的统计查询
- 添加完整的单元测试和集成测试
- 更新API文档
- 优化查询性能使用Promise.all并行查询

Closes #45"

# 推送分支
git push origin feat/clothing-statistics
```

### 创建Pull Request
1. 在GitHub上创建PR
2. 填写PR描述
3. 请求代码审查
4. 根据反馈修改
5. 合并到main分支

---

## 第11步：部署验证

### 本地验证
```bash
# 启动本地服务器
npm run dev

# 测试API
curl -X GET http://localhost:3000/api/v1/clothing/statistics \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 生产验证
```bash
# 部署后验证
curl -X GET https://api.stylevault.com/api/v1/clothing/statistics \
  -H "Authorization: Bearer PROD_TOKEN"
```

---

## 🔍 常见问题与解决方案

### 1. 数据库查询慢
```typescript
// 优化：添加索引
await queryInterface.addIndex('clothing_items', ['user_id', 'category_id']);
await queryInterface.addIndex('clothing_items', ['user_id', 'season_id']);
```

### 2. 内存使用过高
```typescript
// 优化：分批处理大量数据
const batchSize = 1000;
let offset = 0;
let hasMore = true;

while (hasMore) {
  const batch = await ClothingItem.findAll({
    where: { userId },
    limit: batchSize,
    offset
  });
  
  // 处理批次数据
  processBatch(batch);
  
  hasMore = batch.length === batchSize;
  offset += batchSize;
}
```

### 3. 并发问题
```typescript
// 使用事务确保数据一致性
await sequelize.transaction(async (t) => {
  const clothing = await ClothingItem.findByPk(clothingId, { transaction: t });
  
  if (!clothing) {
    throw new AppError('CLOTHING_NOT_FOUND', 404, '衣物不存在');
  }
  
  await clothing.update({ isFavorite: !clothing.isFavorite }, { transaction: t });
});
```

---

## 📈 性能优化建议

1. **数据库优化**
   - 添加适当的索引
   - 使用查询缓存
   - 避免N+1查询问题

2. **API优化**
   - 实现数据缓存
   - 使用分页查询
   - 压缩响应数据

3. **监控指标**
   - API响应时间
   - 数据库查询时间
   - 内存使用情况
   - 错误率统计

---

## 🎯 总结

通过这个完整的接口开发案例，你学会了：

1. **需求分析**：明确接口功能和业务规则
2. **数据库设计**：设计高效的查询方案
3. **代码实现**：遵循规范的编码标准
4. **测试覆盖**：确保代码质量和可靠性
5. **文档维护**：保持API文档的同步更新
6. **部署验证**：确保功能在生产环境正常工作

这套流程适用于所有后端接口开发，可以根据具体需求进行调整和扩展。