# StyleVault 后端环境配置与启动指南

## 🚀 快速启动

### 1. 环境检查

在开始之前，请确保你的系统满足以下要求：

#### 系统要求
- **操作系统**: macOS (ARM架构) / Windows / Linux
- **Node.js**: ≥18.0.0
- **MySQL**: ≥8.0.0
- **Redis**: ≥6.0.0 (可选，用于缓存)

#### 工具检查
```bash
# 检查Node.js版本
node --version

# 检查npm版本
npm --version

# 检查MySQL
mysql --version

# 检查Redis (可选)
redis-server --version
```

### 2. 环境配置

#### 2.1 克隆项目
```bash
cd /Users/sunxiaokai/Desktop/stylevault-vue-project
cd backend
```

#### 2.2 安装依赖
```bash
# 使用ARM架构优化安装
npm install --target_arch=arm64

# 如果遇到权限问题，使用：
sudo npm install --target_arch=arm64
```

#### 2.3 环境变量配置

创建环境文件：
```bash
cp .env.example .env
```

编辑 `.env` 文件：
```bash
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=stylevault_dev
DB_USER=root
DB_PASSWORD=your_password

# JWT配置
JWT_SECRET=your_jwt_secret_key_here
JWT_EXPIRES_IN=7d

# 服务器配置
PORT=3000
NODE_ENV=development

# Redis配置 (可选)
REDIS_HOST=localhost
REDIS_PORT=6379

# 文件上传配置
UPLOAD_MAX_SIZE=5MB
UPLOAD_DIR=uploads/
```

#### 2.4 数据库设置

##### 创建数据库
```bash
# 登录MySQL
mysql -u root -p

# 创建数据库
CREATE DATABASE stylevault_dev CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建用户并授权（可选）
CREATE USER 'stylevault'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON stylevault_dev.* TO 'stylevault'@'localhost';
FLUSH PRIVILEGES;
```

##### 运行迁移
```bash
# 运行所有迁移
npm run db:migrate

# 如果有种子数据
npm run db:seed
```

### 3. 启动服务

#### 3.1 开发模式启动
```bash
# 启动开发服务器
npm run dev

# 或使用特定端口
PORT=3001 npm run dev
```

#### 3.2 生产模式启动
```bash
# 构建项目
npm run build

# 启动生产服务器
npm start
```

#### 3.3 使用PM2启动（推荐）
```bash
# 安装PM2
npm install -g pm2

# 启动应用
pm2 start dist/app.js --name stylevault-backend

# 查看状态
pm2 status

# 停止应用
pm2 stop stylevault-backend

# 重启应用
pm2 restart stylevault-backend
```

### 4. 验证安装

#### 4.1 健康检查
```bash
# 测试API
curl http://localhost:3000/api/v1/health

# 应该返回：
# {"success":true,"message":"服务运行正常"}
```

#### 4.2 数据库连接测试
```bash
# 测试数据库连接
npm run db:test
```

### 5. 开发工具配置

#### 5.1 VS Code配置

创建 `.vscode/settings.json`：
```json
{
  "typescript.preferences.importModuleSpecifier": "relative",
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "files.exclude": {
    "**/node_modules": true,
    "**/dist": true,
    "**/.git": true
  }
}
```

#### 5.2 调试配置

创建 `.vscode/launch.json`：
```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Debug Backend",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/backend/src/app.ts",
      "env": {
        "NODE_ENV": "development"
      },
      "outFiles": ["${workspaceFolder}/backend/dist/**/*.js"],
      "sourceMaps": true,
      "console": "integratedTerminal"
    }
  ]
}
```

### 6. 常见问题解决

#### 6.1 端口占用
```bash
# 查找占用端口的进程
lsof -i :3000

# 终止进程
kill -9 <PID>
```

#### 6.2 MySQL连接错误
```bash
# 检查MySQL服务状态
brew services list

# 启动MySQL
brew services start mysql

# 重置密码（如果需要）
mysql_secure_installation
```

#### 6.3 权限问题
```bash
# 修复npm权限
sudo chown -R $(whoami) ~/.npm

# 修复文件权限
sudo chown -R $(whoami) /usr/local/lib/node_modules
```

#### 6.4 内存不足
```bash
# 增加Node.js内存限制
export NODE_OPTIONS="--max-old-space-size=4096"

# 在package.json中添加
"scripts": {
  "dev": "node --max-old-space-size=4096 -r ts-node/register src/app.ts"
}
```

### 7. 性能优化

#### 7.1 数据库优化
```bash
# 添加数据库索引
npm run db:add-index

# 优化查询
npm run db:optimize
```

#### 7.2 缓存配置
```bash
# 启动Redis（如果使用）
redis-server

# 验证Redis连接
redis-cli ping
```

### 8. 监控与日志

#### 8.1 日志配置

创建 `src/config/logger.ts`：
```typescript
import winston from 'winston';

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  defaultMeta: { service: 'stylevault-backend' },
  transports: [
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
    new winston.transports.File({ filename: 'logs/combined.log' }),
    new winston.transports.Console({
      format: winston.format.simple()
    })
  ]
});

export default logger;
```

#### 8.2 性能监控
```bash
# 安装监控工具
npm install --save express-status-monitor

# 访问监控面板
http://localhost:3000/status
```

### 9. 自动化脚本

#### 9.1 一键启动脚本

创建 `scripts/start-dev.sh`：
```bash
#!/bin/bash

echo "🚀 启动StyleVault后端开发环境..."

# 检查环境
if [ ! -f ".env" ]; then
    echo "❌ .env文件不存在，请复制.env.example并配置"
    exit 1
fi

# 检查数据库连接
if ! mysql -h localhost -u root -p -e "USE stylevault_dev" 2>/dev/null; then
    echo "❌ 数据库连接失败，请检查MySQL服务"
    exit 1
fi

# 安装依赖
echo "📦 安装依赖..."
npm install --target_arch=arm64

# 运行迁移
echo "🗄️ 运行数据库迁移..."
npm run db:migrate

# 启动开发服务器
echo "🌟 启动开发服务器..."
npm run dev
```

赋予执行权限：
```bash
chmod +x scripts/start-dev.sh
```

#### 9.2 生产部署脚本

创建 `scripts/deploy.sh`：
```bash
#!/bin/bash

echo "🚀 部署StyleVault后端..."

# 拉取最新代码
git pull origin main

# 安装依赖
npm ci --only=production --target_arch=arm64

# 构建应用
npm run build

# 重启PM2
pm2 restart stylevault-backend

# 健康检查
sleep 5
curl -f http://localhost:3000/api/v1/health || exit 1

echo "✅ 部署完成"
```

### 10. 环境检查清单

#### 开发环境检查
```bash
#!/bin/bash
echo "🔍 检查开发环境..."

# Node.js版本
node_version=$(node --version)
echo "Node.js版本: $node_version"

# MySQL连接
if mysql -h localhost -u root -p -e "SELECT 1" 2>/dev/null; then
    echo "✅ MySQL连接正常"
else
    echo "❌ MySQL连接失败"
fi

# Redis连接（可选）
if redis-cli ping 2>/dev/null; then
    echo "✅ Redis连接正常"
else
    echo "⚠️  Redis未连接（可选）"
fi

# 端口检查
if lsof -i :3000 2>/dev/null; then
    echo "⚠️  端口3000已被占用"
else
    echo "✅ 端口3000可用"
fi
```

### 11. 故障排除指南

#### 11.1 连接问题
```bash
# 测试数据库连接
mysql -h localhost -u root -p stylevault_dev -e "SELECT 1"

# 测试Redis连接
redis-cli -h localhost -p 6379 ping
```

#### 11.2 日志查看
```bash
# 查看应用日志
tail -f logs/combined.log

# 查看错误日志
tail -f logs/error.log

# 查看PM2日志
pm2 logs stylevault-backend
```

#### 11.3 性能问题
```bash
# 检查内存使用
node --max-old-space-size=4096 src/app.ts

# 使用clinic.js诊断
npm install -g clinic
clinic doctor -- node dist/app.js
```

### 12. 开发工作流

#### 12.1 日常开发流程
```bash
# 1. 启动开发环境
./scripts/start-dev.sh

# 2. 创建功能分支
git checkout -b feat/your-feature

# 3. 开发并测试
npm run test:watch

# 4. 提交代码
git add .
git commit -m "feat: add new feature"

# 5. 推送到远程
git push origin feat/your-feature
```

#### 12.2 代码质量检查
```bash
# 运行代码检查
npm run lint

# 自动修复
npm run lint:fix

# 格式化代码
npm run format

# 运行测试
npm test

# 检查测试覆盖率
npm run test:coverage
```

---

## 🎯 快速验证

完成以上步骤后，访问以下URL验证服务：

1. **健康检查**: http://localhost:3000/api/v1/health
2. **API文档**: http://localhost:3000/api-docs
3. **监控面板**: http://localhost:3000/status
4. **数据库**: 检查数据是否正确迁移

---

## 📞 支持

如果遇到问题：
1. 查看 [故障排除指南](#故障排除指南)
2. 检查日志文件
3. 提交Issue到GitHub
4. 联系开发团队

**记住**: 环境配置是开发的第一步，确保所有依赖都正确安装和配置。